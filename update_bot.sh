#!/bin/bash

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
# –°—Å—ã–ª–∫–∞ –Ω–∞ RAW –≤–µ—Ä—Å–∏—é —Ñ–∞–π–ª–∞ main.py –Ω–∞ GitHub
# –ü—Ä–∏–º–µ—Ä: https://raw.githubusercontent.com/User/Repo/main/main.py
GITHUB_RAW_URL="https://raw.githubusercontent.com/Mytop244/parser-bot/refs/heads/main/main.py"

# –ò–º—è —Ñ–∞–π–ª–∞ —Å–∫—Ä–∏–ø—Ç–∞ –∏ —Ñ–∞–π–ª–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
SCRIPT_NAME="main.py"
REQUIREMENTS="requirements.txt"

# –ü–∞–ø–∫–∞ –¥–ª—è –±—ç–∫–∞–ø–æ–≤ (—Å–æ–∑–¥–∞—Å—Ç—Å—è —Å–∞–º–∞)
BACKUP_DIR="backups"

# --- –õ–û–ì–ò–ö–ê ---

echo "üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π..."

# 1. –°–∫–∞—á–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Ñ–∞–π–ª –≤–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∏–º—è
curl -s -L "$GITHUB_RAW_URL" -o "${SCRIPT_NAME}.new"

# 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–∫–∞—á–∞–ª—Å—è –ª–∏ —Ñ–∞–π–ª (—Ä–∞–∑–º–µ—Ä > 0)
if [ -s "${SCRIPT_NAME}.new" ]; then
    echo "‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞."

    # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –±—ç–∫–∞–ø–æ–≤, –µ—Å–ª–∏ –Ω–µ—Ç
    mkdir -p "$BACKUP_DIR"

    # 3. –î–µ–ª–∞–µ–º –±—ç–∫–∞–ø —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ (—Å –¥–∞—Ç–æ–π –∏ –≤—Ä–µ–º–µ–Ω–µ–º)
    if [ -f "$SCRIPT_NAME" ]; then
        TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
        cp "$SCRIPT_NAME" "$BACKUP_DIR/${SCRIPT_NAME}_$TIMESTAMP.bak"
        echo "üì¶ –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ $BACKUP_DIR"
    fi

    # 4. –ó–∞–º–µ–Ω—è–µ–º —Ñ–∞–π–ª
    mv "${SCRIPT_NAME}.new" "$SCRIPT_NAME"
    echo "üìÑ –§–∞–π–ª $SCRIPT_NAME –æ–±–Ω–æ–≤–ª–µ–Ω."

    # (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏, –µ—Å–ª–∏ requirements.txt —Ç–æ–∂–µ –Ω–∞ –≥–∏—Ç–µ
    # curl -s -L "URL_TO_REQUIREMENTS" -o requirements.txt
    # pip install -r requirements.txt

    # 5. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
    echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –±–æ—Ç–∞..."
    # –£–±–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å python, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç main.py
    pkill -f "python $SCRIPT_NAME"
    
    # –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞
    sleep 2

    echo "üöÄ –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏..."
    # –ó–∞–ø—É—Å–∫–∞–µ–º –≤ —Ñ–æ–Ω–µ (&) –∏ –æ—Ç–≤—è–∑—ã–≤–∞–µ–º –æ—Ç —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ (nohup), 
    # —á—Ç–æ–±—ã –±–æ—Ç —Ä–∞–±–æ—Ç–∞–ª –¥–∞–∂–µ –µ—Å–ª–∏ –≤—ã –∑–∞–∫—Ä–æ–µ—Ç–µ Termux
    nohup python "$SCRIPT_NAME" > bot_output.log 2>&1 &
    
    echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –ë–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω –≤ —Ñ–æ–Ω–µ. –õ–æ–≥–∏ –ø–∏—à—É—Ç—Å—è –≤ bot_output.log"

else
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏–ª–∏ URL."
    # –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç–æ–π –∏–ª–∏ –±–∏—Ç—ã–π —Ñ–∞–π–ª
    rm -f "${SCRIPT_NAME}.new"
fi